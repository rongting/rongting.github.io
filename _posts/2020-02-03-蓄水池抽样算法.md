---
title: 蓄水池抽样算法
tags: 算法
---

**问题描述：给定一个数据流，数据流长度N很大，且N直到处理完所有数据之前都不可知，请问如何在只遍历一遍数据（O(N)）的情况下，能够随机选取出m个不重复的数据。**
这个场景强调了3件事：
1.数据流长度N很大且不可知，所以不能一次性存入内存。
2.时间复杂度为O(N)。
3.随机选取m个数，每个数被选中的概率为m/N。

**使用蓄水池抽样算法可以解决上述问题，算法思路大致如下：**
数据编号为1到N，
1.如果接收的数据量小于等于m，则依次放入蓄水池。
2.当接收到第i个数据时，i > m，在[1, i]范围内取以随机数d，若d的落在[1, m]范围内，则用接收到的第i个数据替换蓄水池中的第d个数据。
重复步骤2。

**算法证明：**
第i个数据最终被放入蓄水池的概率P = 当遍历到第i个数据时该数据被加入蓄水池的概率P1 * 之后该数据不会被替换的概率P2。
（1）对于1<= i <= m, P1 = 1; P2为从第m+1个数据开始，不替换当前数据的概率。我们从第m+1个数据开始计算，第m+1个数据替换当前数据的概率 = 1/(m+1)，因此第m+1个数据不替换当前数据的概率 = 1 - 1/(m+1) = m/(m+1); 同理第m+2个数据不替换当前数据的概率 = (m+1)/(m+2); 以此类推，第N个数据不替换当前数据的概率 = (N-1)/N。
综上，P2 = m/(m+1) * (m+1)/(m+2) *......* (N-1)/N = m/N。因此P = P1 * P2 = m/N。
（2）对于i > m, 假设i = m+k, 则P1 = m/(m+k); P2 = (m+k)/(m+k+1) * (m+k+1)/(m+k+2) *......* (N-1)/N = (m+k)/N; 因此P = P1 * P2 = m/N。
**易见，蓄水池算法可以保证每个数被pick的概率均为m/N。**

**关于蓄水池算法的例子，参加leetcode382-链表随机节点 ：** [https://leetcode-cn.com/problems/linked-list-random-node/](https://links.jianshu.com/go?to=https%3A%2F%2Fleetcode-cn.com%2Fproblems%2Flinked-list-random-node%2F)